#include <Wire.h>
#include <OPT3101.h>
#include <ESP32Servo.h>

#define SERVO_PIN 9  
#define MOTOR_IN1 A1  
#define MOTOR_IN2 A2  
#define MOTOR_SPEED 8  

Servo myservo;
OPT3101 sensor;

int servoStraight = 90;  
int servoLeft = 120;     
int servoRight = 60;     
int servoPosition = 90;  

int lastDistance0 = 600;  
int lastDistance1 = 600;  
int lastDistance2 = 600;  

unsigned long lastPreprekaTime = 0;
const int preprekaCooldown = 500;  
const int stabilizacijaVremena = 200;  

int motorSpeed = 40;  // âœ… Ã„NNU LÃ„GRE HASTIGHET!
const int hinderMin = 100;  
const int hinderMax = 300;  

void setup() {
  Serial.begin(115200);
  delay(1000);

  Serial.println("ðŸ”„ Startar...");
  Wire.begin(A4, A5);

  sensor.init();
  if (sensor.getLastError()) {
    Serial.print("âŒ Sensorfel: ");
    Serial.println(sensor.getLastError());
    while (1);
  }

  sensor.configureDefault();
  sensor.setFrameTiming(32);
  sensor.setBrightness(OPT3101Brightness::High);
  sensor.enableTimingGenerator();

  myservo.attach(SERVO_PIN);
  myservo.write(servoStraight);

  pinMode(MOTOR_IN1, OUTPUT);
  pinMode(MOTOR_IN2, OUTPUT);
  pinMode(MOTOR_SPEED, OUTPUT);
  
  digitalWrite(MOTOR_IN1, HIGH);
  digitalWrite(MOTOR_IN2, LOW);
  analogWrite(MOTOR_SPEED, motorSpeed);  // âœ… Ã„NNU LÃ…NGSAMMARE

  Serial.println("âœ… System klart!");
  sensor.setChannel(0);
  sensor.startSample();
}

void loop() {
  if (sensor.isSampleDone()) {
    sensor.readOutputRegs();
    int16_t distance = sensor.distanceMillimeters;
    int currentChannel = sensor.channelUsed;
    unsigned long currentTime = millis();

    Serial.print("ðŸ“¡ Kanal: ");
    Serial.print(currentChannel);
    Serial.print(" | Avstojanje: ");
    Serial.print(distance);
    Serial.println(" mm");

    if (distance == 0) {
      Serial.println("âš ï¸ Ogiltigt vÃ¤rde - ignorerar!");
      sensor.startSample();
      delay(300);
      return;
    }

    // âœ… Om inga hinder, servo i mitten, motor alltid lÃ¥ngsam
    if (lastDistance0 > hinderMax && lastDistance1 > hinderMax && lastDistance2 > hinderMax) {  
      if (servoPosition != servoStraight) {
        Serial.println("ðŸ”„ Inga hinder, servo i mitten.");
        servoPosition = servoStraight;
        myservo.write(servoPosition);
      }
      analogWrite(MOTOR_SPEED, motorSpeed);  // âœ… HÃ¥ller lÃ¥g hastighet
    }

    // âœ… Om hinder till hÃ¶ger, svÃ¤ng vÃ¤nster
    if (lastDistance0 >= hinderMin && lastDistance0 <= hinderMax) {
      Serial.println("âž¡ï¸ Hinder hÃ¶ger! Servo VÃ„NSTER.");
      servoPosition = servoLeft;
      myservo.write(servoPosition);
    }

    // âœ… Om hinder till vÃ¤nster, svÃ¤ng hÃ¶ger
    if (lastDistance2 >= hinderMin && lastDistance2 <= hinderMax) {
      Serial.println("â¬…ï¸ Hinder vÃ¤nster! Servo HÃ–GER.");
      servoPosition = servoRight;
      myservo.write(servoPosition);
    }

    // âœ… Om hinder RAKT FRAM (â‰¤ 100 mm), motor STOPP
    if (lastDistance1 <= hinderMin) {
      Serial.println("ðŸš¨ Hinder FRAMFÃ–R! Motor STOPP!");
      digitalWrite(MOTOR_IN1, LOW);
      digitalWrite(MOTOR_IN2, LOW);
      analogWrite(MOTOR_SPEED, 0);  
    }

    lastDistance0 = distance;

    // âœ… VÃ¤xla kanal fÃ¶r att mÃ¤ta nÃ¤sta omrÃ¥de
    if (currentChannel == 0) {
      sensor.setChannel(1);
    } else if (currentChannel == 1) {
      sensor.setChannel(2);
    } else {
      sensor.setChannel(0);
    }

    sensor.startSample();
    delay(500);
  }
}
