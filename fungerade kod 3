#include <Wire.h>
#include <OPT3101.h>
#include <ESP32Servo.h>

#define SERVO_PIN 9  
#define MOTOR_IN1 A1  
#define MOTOR_IN2 A2  
#define MOTOR_SPEED 8  

Servo myservo;
OPT3101 sensor;

int servoStraight = 96;  // ðŸ”¥ Ã–kat frÃ¥n 92 till 96 fÃ¶r att korrigera hÃ¶gerdragning
int servoLeft = 140;   // ðŸ”¥ StÃ¶rre svÃ¤ng Ã¥t vÃ¤nster
int servoRight = 50;   // ðŸ”¥ Mindre svÃ¤ng Ã¥t hÃ¶ger
int servoPosition = 96;  
int servoSwing = 5;  // ðŸ”¥ Minskat fiskrÃ¶relse fÃ¶r mer stabilitet

int lastDistance0 = 600;  
int lastDistance1 = 600;  
int lastDistance2 = 600;  

unsigned long lastPreprekaTime = 0;
const int hinderMin = 100;  
const int hinderMax = 400;  
const int motorSpeed = 5;  

bool motorOn = true;
unsigned long lastMotorToggle = 0;
const int motorInterval = 200;  

bool fishMode = true;  
unsigned long lastSensorRead = 0;
const int sensorInterval = 150;  // ðŸ”¥ Snabbare sensoravlÃ¤sning

void setup() {
  Serial.begin(115200);
  delay(500);

  Serial.println("ðŸ”„ Startar...");
  Wire.begin(A4, A5);

  sensor.init();
  if (sensor.getLastError()) {
    Serial.print("âŒ Sensorfel: ");
    Serial.println(sensor.getLastError());
    while (1);
  }

  sensor.configureDefault();
  sensor.setFrameTiming(16);  // ðŸ”¥ Snabbare sensoravlÃ¤sning
  sensor.setBrightness(OPT3101Brightness::High);
  sensor.enableTimingGenerator();

  myservo.attach(SERVO_PIN);
  myservo.write(servoStraight);

  pinMode(MOTOR_IN1, OUTPUT);
  pinMode(MOTOR_IN2, OUTPUT);
  pinMode(MOTOR_SPEED, OUTPUT);
  
  digitalWrite(MOTOR_IN1, HIGH);
  digitalWrite(MOTOR_IN2, LOW);
  analogWrite(MOTOR_SPEED, motorSpeed);  

  Serial.println("âœ… System klart!");
  sensor.setChannel(0);
  sensor.startSample();
}

void loop() {
  unsigned long currentTime = millis();

  // ðŸ”¥ Snabbare sensoravlÃ¤sning
  if (currentTime - lastSensorRead > sensorInterval) {
    lastSensorRead = currentTime;

    if (sensor.isSampleDone()) {
      sensor.readOutputRegs();
      int16_t distance = sensor.distanceMillimeters;
      int currentChannel = sensor.channelUsed;

      Serial.print("ðŸ“¡ Kanal: ");
      Serial.print(currentChannel);
      Serial.print(" | AvstÃ¥nd: ");
      Serial.print(distance);
      Serial.println(" mm");

      if (distance == 0) {
        Serial.println("âš ï¸ Ogiltigt vÃ¤rde - ignorerar!");
        sensor.startSample();
        return;
      }

      // âœ… Om inga hinder â€“ aktivera fiskrÃ¶relse
      if (lastDistance0 > hinderMax && lastDistance1 > hinderMax && lastDistance2 > hinderMax) {  
        if (!fishMode) {
          Serial.println("ðŸ”„ Inga hinder, Ã¥tergÃ¥r till fiskrÃ¶relse.");
          fishMode = true;
        }
      } else {
        fishMode = false;  // ðŸ”¥ StÃ¤nger av fiskrÃ¶relsen om hinder finns
      }

      // âœ… Om hinder till hÃ¶ger (100â€“400 mm), svÃ¤ng vÃ¤nster SNABBT
      if (lastDistance0 >= hinderMin && lastDistance0 <= hinderMax) {
        Serial.println("âž¡ï¸ Hinder hÃ¶ger! SNABB VÃ„NSTER.");
        myservo.write(servoLeft);
      }

      // âœ… Om hinder till vÃ¤nster (100â€“400 mm), svÃ¤ng hÃ¶ger SNABBT
      if (lastDistance2 >= hinderMin && lastDistance2 <= hinderMax) {
        Serial.println("â¬…ï¸ Hinder vÃ¤nster! SNABB HÃ–GER.");
        myservo.write(servoRight);
      }

      // âœ… Om hinder RAKT FRAM (â‰¤ 100 mm), motor STOPP
      if (lastDistance1 <= hinderMin) {
        Serial.println("ðŸš¨ Hinder FRAMFÃ–R! Motor STOPP!");
        digitalWrite(MOTOR_IN1, LOW);
        digitalWrite(MOTOR_IN2, LOW);
        analogWrite(MOTOR_SPEED, 0);  
      }

      lastDistance0 = distance;

      // âœ… VÃ¤xla kanal fÃ¶r att mÃ¤ta nÃ¤sta omrÃ¥de
      if (currentChannel == 0) {
        sensor.setChannel(1);
      } else if (currentChannel == 1) {
        sensor.setChannel(2);
      } else {
        sensor.setChannel(0);
      }

      sensor.startSample();
    }
  }

  // âœ… FiskrÃ¶relse: Servo gungar vÃ¤nster-hÃ¶ger om inga hinder finns
  if (fishMode) {
    static bool swingRight = true;
    static unsigned long lastSwingTime = 0;
    const int swingInterval = 350;  // ðŸ”¥ Ã„nnu snabbare gungning fÃ¶r bÃ¤ttre styrning

    if (millis() - lastSwingTime > swingInterval) {
      if (swingRight) {
        myservo.write(servoStraight + servoSwing);
      } else {
        myservo.write(servoStraight - (servoSwing - 2));  // ðŸ”¥ GÃ¶r vÃ¤nstersvÃ¤ng lite svagare
      }
      swingRight = !swingRight;
      lastSwingTime = millis();
    }
  }
}
